<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Football Player Prop Odds Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        .glassmorphic {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .neumorphic-button {
            background: #f0f2f5;
            box-shadow: 6px 6px 12px #c5c7ca, -6px -6px 12px #ffffff;
            transition: all 0.2s ease-in-out;
        }
        .neumorphic-button:hover {
            box-shadow: 4px 4px 8px #c5c7ca, -4px -4px 8px #ffffff;
        }
        .neumorphic-button:active {
            box-shadow: inset 4px 4px 8px #c5c7ca, inset -4px -4px 8px #ffffff;
        }
        .loader {
            border-top-color: #007aff;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="none" stroke="%236b7280" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l4 4 4-4"/></svg>');
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1em;
        }
        .tab-button.active {
            color: #007aff;
            border-bottom: 2px solid #007aff;
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="api-usage-tracker" class="hidden fixed top-4 right-4 z-50 text-white py-2 px-4 rounded-lg shadow-lg text-sm font-medium">
        API Requests Remaining: <span id="api-requests-remaining">N/A</span>
    </div>

    <div class="container mx-auto p-4 md:p-8">
        
        <header class="text-center mb-12">
            <h1 class="text-4xl font-bold text-gray-900 mb-2">Football Prop Builder</h1>
            <p class="text-gray-600">Build, customize, and export player prop markets.</p>
        </header>

        <main>
            <div id="main-content" class="glassmorphic rounded-2xl shadow-lg p-6 md:p-8">
                
                <div id="fetch-section" class="space-y-4 text-center">
                    <div>
                         <label for="leagueDropdown" class="block text-sm font-medium text-gray-700 mb-2">Select a League</label>
                         <select id="leagueDropdown" class="w-full max-w-md mx-auto p-3 bg-white bg-opacity-80 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="soccer_epl">English Premier League</option>
                            <option value="soccer_spain_la_liga">Spain La Liga</option>
                            <option value="soccer_italy_serie_a">Italy Serie A</option>
                            <option value="soccer_germany_bundesliga">Germany Bundesliga</option>
                            <option value="soccer_france_ligue_one">France Ligue 1</option>
                         </select>
                     </div>
                    <button id="fetchEventsButton" class="neumorphic-button text-gray-800 font-bold py-3 px-8 rounded-full transition duration-300">
                        Fetch Upcoming Games
                    </button>
                </div>

                <div id="game-selection-area" class="hidden space-y-6">
                     <div>
                         <label for="eventsDropdown" class="block text-sm font-medium text-gray-700 mb-2">Select a Game</label>
                         <select id="eventsDropdown" class="w-full p-3 bg-white bg-opacity-80 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500">
                         </select>
                     </div>
                     
                     <div id="tabs-container" class="hidden">
                        <div class="border-b border-gray-200">
                            <nav id="tabs" class="flex space-x-8" aria-label="Tabs">
                                <button class="tab-button active font-medium py-3 px-1 text-sm" data-tab="builder">CSV Builder</button>
                                <button class="tab-button text-gray-500 hover:text-gray-700 font-medium py-3 px-1 text-sm" data-tab="all-odds">All Odds</button>
                            </nav>
                        </div>
                        <div id="tab-content" class="mt-6">
                            <div id="builder-tab-content" class="space-y-4"></div>
                            <div id="all-odds-tab-content" class="hidden space-y-6"></div>
                        </div>
                     </div>
                </div>
            </div>

            <div id="loader" class="hidden justify-center items-center mt-8">
                <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-32 w-32"></div>
            </div>
            
            <div id="error" class="hidden mt-8 text-center bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl relative" role="alert">
                <strong class="font-bold">Error!</strong>
                <span class="block sm:inline" id="errorMessage"></span>
            </div>

            <div id="usage-info-container" class="hidden mt-4 text-center text-sm text-gray-600">
                <p>API Key Usage (Last Request): <span id="usage-info-details" class="font-medium"></span></p>
            </div>

        </main>
    </div>

    <div id="csvPreviewModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="glassmorphic rounded-2xl shadow-xl w-full max-w-4xl">
            <div class="p-6">
                <h3 class="text-xl font-semibold text-gray-900 text-center mb-4">CSV Preview</h3>
                <div class="bg-gray-100 bg-opacity-70 p-4 rounded-xl max-h-96 overflow-auto">
                    <pre id="csvPreviewContent" class="text-xs sm:text-sm text-gray-700"></pre>
                </div>
                <div class="mt-6">
                    <button id="closeModalButton" class="w-full py-3 px-4 bg-gray-700 text-white font-medium rounded-xl hover:bg-gray-800 transition-colors focus:outline-none focus:ring-2 focus:ring-gray-500">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const regions = 'us';
        const oddsFormat = 'decimal';

        const marketsMap = {
            'player_goal_scorer_anytime': 'Anytime Goal Scorer',
            'player_first_goal_scorer': 'First Goal Scorer',
            'player_last_goal_scorer': 'Last Goal Scorer',
            'player_to_receive_card': 'Player to Receive Card',
            'player_to_receive_red_card': 'Player to Receive Red Card',
            'player_shots_on_target': 'Shots on Target',
            'player_shots': 'Shots',
            'player_assists': 'Assists'
        };
        const markets = Object.keys(marketsMap).join(',');

        // DOM Elements
        const leagueDropdown = document.getElementById('leagueDropdown');
        const fetchEventsButton = document.getElementById('fetchEventsButton');
        const gameSelectionArea = document.getElementById('game-selection-area');
        const eventsDropdown = document.getElementById('eventsDropdown');
        const tabsContainer = document.getElementById('tabs-container');
        const tabs = document.getElementById('tabs');
        const builderTabContent = document.getElementById('builder-tab-content');
        const allOddsTabContent = document.getElementById('all-odds-tab-content');
        const loader = document.getElementById('loader');
        const errorDiv = document.getElementById('error');
        const errorMessage = document.getElementById('errorMessage');
        const modal = document.getElementById('csvPreviewModal');
        const closeModalButton = document.getElementById('closeModalButton');
        
        // State variables
        let fetchedEvents = [];
        let allPlayersData = {};
        let currentFullGameData = null;
        let currentEventCommenceTime = null;
        let selectedDataForExport = {}; 
        let soccerPlayersData = []; 

        // *** AŽURIRANA FUNKCIJA ***
        function displayUsageInfo(usageInfo) {
            // 1. Handle the bottom usage info container (as before)
            const usageContainer = document.getElementById('usage-info-container');
            const usageDetails = document.getElementById('usage-info-details');
            if (usageInfo && (usageInfo.remaining || usageInfo.used)) {
                usageDetails.textContent = `Key: ${usageInfo.keyUsed} | Remaining: ${usageInfo.remaining || 'N/A'} | Used: ${usageInfo.used || 'N/A'}`;
                usageContainer.classList.remove('hidden');
            }

            // 2. Handle the new top-right tracker
            const usageTracker = document.getElementById('api-usage-tracker');
            const remainingSpan = document.getElementById('api-requests-remaining');
            
            if (usageInfo && usageInfo.remaining) {
                const remaining = parseInt(usageInfo.remaining, 10);
                remainingSpan.textContent = remaining;
                
                // Add warning class if below 50
                if (remaining < 50) {
                    usageTracker.classList.add('bg-red-600');
                    usageTracker.classList.remove('bg-blue-600', 'bg-gray-500');
                } else {
                    usageTracker.classList.add('bg-blue-600');
                    usageTracker.classList.remove('bg-red-600', 'bg-gray-500');
                }
                
                usageTracker.classList.remove('hidden');

            } else if (usageInfo) {
                // Show the tracker even if 'remaining' is not available
                remainingSpan.textContent = 'N/A';
                usageTracker.classList.add('bg-gray-500'); // Use a neutral color
                usageTracker.classList.remove('bg-red-600', 'bg-blue-600');
                usageTracker.classList.remove('hidden');
            }
            // Ako usageInfo ne postoji, tracker ostaje sakriven
        }

        async function loadSoccerPlayersData() { 
            try {
                // Učitavamo novi JSON fajl
                const response = await fetch('./soccer_players.json'); 
                if (!response.ok) {
                    throw new Error(`HTTP greška! status: ${response.status}`);
                }
                soccerPlayersData = await response.json();

            } catch (error) {
                console.error("Neuspešno učitavanje podataka o fudbalerima iz JSON fajla:", error);
                errorMessage.textContent = "Neuspešno učitavanje soccer_players.json. Proverite da li fajl postoji.";
                errorDiv.classList.remove('hidden');
            }
        }
        
        function findPlayerTeam(playerName) {
            const player = soccerPlayersData.find(p => p.name === playerName);
            return player ? player.team : 'N/A';
        }

        // Učitavamo podatke o igračima odmah
        document.addEventListener('DOMContentLoaded', loadSoccerPlayersData); 


        fetchEventsButton.addEventListener('click', async () => {
            const selectedSport = leagueDropdown.value; // Dobijamo vrednost iz novog dropdown-a
            if (!selectedSport) {
                errorMessage.textContent = "Please select a league first.";
                errorDiv.classList.remove('hidden');
                return;
            }

            gameSelectionArea.classList.add('hidden');
            tabsContainer.classList.add('hidden');
            errorDiv.classList.add('hidden');
            loader.classList.remove('hidden');
            loader.classList.add('flex');
            fetchEventsButton.disabled = true;
            fetchEventsButton.classList.add('opacity-50', 'cursor-not-allowed');

            try {
                const cacheKey = `soccerEvents_${selectedSport}`;
                const cachedEvents = sessionStorage.getItem(cacheKey); 
                
                if (cachedEvents) {
                    fetchedEvents = JSON.parse(cachedEvents);
                    const lastUsage = sessionStorage.getItem('lastApiUsage');
                    if(lastUsage) {
                        displayUsageInfo(JSON.parse(lastUsage));
                    }
                } else {
                    // Pozivamo 'get-events' sa odabranim sportom
                    const eventsUrl = `/.netlify/functions/get-events?sport=${selectedSport}`;
                    const eventsResponse = await fetch(eventsUrl);
                    if (!eventsResponse.ok) {
                        const errorData = await eventsResponse.json();
                        throw new Error(`Failed to fetch events: ${errorData.message || eventsResponse.statusText}`);
                    }
                    
                    const responseBody = await eventsResponse.json();
                    fetchedEvents = responseBody.data; 
                    
                    if (responseBody.usageInfo) {
                        displayUsageInfo(responseBody.usageInfo);
                        sessionStorage.setItem('lastApiUsage', JSON.stringify(responseBody.usageInfo)); 
                    }
                    
                    sessionStorage.setItem(cacheKey, JSON.stringify(fetchedEvents)); 
                }

                if (fetchedEvents.length === 0) {
                     gameSelectionArea.classList.remove('hidden');
                     eventsDropdown.innerHTML = `<option value="">No upcoming events found for ${selectedSport}.</option>`; 
                } else {
                    populateEventsDropdown(fetchedEvents);
                    gameSelectionArea.classList.remove('hidden');
                }
                document.getElementById('fetch-section').classList.add('hidden');

            } catch (error) {
                console.error('An error occurred:', error);
                errorMessage.textContent = error.message;
                errorDiv.classList.remove('hidden');
            } finally {
                loader.classList.add('hidden');
                loader.classList.remove('flex');
                fetchEventsButton.disabled = false;
                fetchEventsButton.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        });
        
        closeModalButton.addEventListener('click', () => {
            modal.classList.add('hidden');
        });

        tabs.addEventListener('click', (e) => {
            const button = e.target.closest('.tab-button');
            if (!button) return;
            switchTab(button.dataset.tab);
        });
        
        function switchTab(tabName) {
            tabs.querySelectorAll('.tab-button').forEach(btn => {
                const isActive = btn.dataset.tab === tabName;
                btn.classList.toggle('active', isActive);
                btn.classList.toggle('text-blue-500', isActive);
                btn.classList.toggle('text-gray-500', !isActive);
                btn.classList.toggle('hover:text-gray-700', !isActive);
            });

            builderTabContent.classList.toggle('hidden', tabName !== 'builder');
            allOddsTabContent.classList.toggle('hidden', tabName !== 'all-odds');
        }

        function populateEventsDropdown(events) {
            eventsDropdown.innerHTML = '<option value="">-- Please select a match --</option>'; 
            events.forEach(event => {
                const option = document.createElement('option');
                option.value = event.id;
                option.dataset.homeTeam = event.home_team;
                option.dataset.awayTeam = event.away_team;
                const commenceTime = new Date(event.commence_time).toLocaleString();
                option.textContent = `${event.home_team} vs ${event.away_team} (${commenceTime})`;
                eventsDropdown.appendChild(option);
            });
        }
        
        eventsDropdown.addEventListener('change', async (e) => {
            const selectedOption = e.target.options[e.target.selectedIndex];
            const eventId = selectedOption.value;
            const homeTeam = selectedOption.dataset.homeTeam;
            const awayTeam = selectedOption.dataset.awayTeam;
            const selectedEvent = fetchedEvents.find(event => event.id === eventId);
            currentEventCommenceTime = selectedEvent ? selectedEvent.commence_time : null;

            // Potreban nam je i 'sport' (liga) za 'get-odds' poziv
            const sport = leagueDropdown.value;

            builderTabContent.innerHTML = '';
            allOddsTabContent.innerHTML = '';
            tabsContainer.classList.add('hidden');
            allPlayersData = {};
            selectedDataForExport = {};
            currentFullGameData = null;

            if (!eventId || !sport) return;
            
            tabsContainer.classList.remove('hidden');
            const miniLoaderHTML = '<div class="flex justify-center p-8"><div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12"></div></div>';
            builderTabContent.innerHTML = miniLoaderHTML;
            allOddsTabContent.innerHTML = miniLoaderHTML;

            try {
                const cacheKey = `soccerOdds_${eventId}`; 
                const cachedOdds = sessionStorage.getItem(cacheKey);

                if (cachedOdds) {
                    currentFullGameData = JSON.parse(cachedOdds);
                    const lastUsage = sessionStorage.getItem('lastApiUsage');
                    if(lastUsage) {
                        displayUsageInfo(JSON.parse(lastUsage));
                    }
                } else {
                    // Prosleđujemo 'sport' u 'get-odds' poziv
                    const oddsUrl = `/.netlify/functions/get-odds?sport=${sport}&eventId=${eventId}&regions=${regions}&markets=${markets}&oddsFormat=${oddsFormat}`;
                    const res = await fetch(oddsUrl);

                    if (!res.ok) {
                        const errorData = await res.json();
                        throw new Error(errorData.message || `HTTP error ${res.status}`);
                    }
                    
                    const responseBody = await res.json();
                    currentFullGameData = responseBody.data; 
                    
                    if (responseBody.usageInfo) {
                        displayUsageInfo(responseBody.usageInfo);
                        sessionStorage.setItem('lastApiUsage', JSON.stringify(responseBody.usageInfo)); 
                    }

                    sessionStorage.setItem(cacheKey, JSON.stringify(currentFullGameData));
                }
                
                processGameDataForBuilder(currentFullGameData);
                setupCsvBuilder(homeTeam, awayTeam);
                renderAllOddsView();

            } catch (error) {
                const errorHTML = `<p class="text-red-500 text-center">Could not fetch player odds: ${error.message}</p>`;
                builderTabContent.innerHTML = errorHTML;
                allOddsTabContent.innerHTML = errorHTML;
            }
        });

        function processGameDataForBuilder(gameData) {
            const bookmakers = gameData.bookmakers || [];
            // Prioriteti kladionica, mogu se prilagoditi
            const pinnacle = bookmakers.find(b => b.key === 'pinnacle');
            const bet365 = bookmakers.find(b => b.key === 'bet365');
            const draftkings = bookmakers.find(b => b.key === 'draftkings');
            const fanduel = bookmakers.find(b => b.key === 'fanduel');
            const caesars = bookmakers.find(b => b.title.toLowerCase().includes('caesars'));
            const betmgm = bookmakers.find(b => b.key === 'betmgm');

            const defaultPriority = [pinnacle, bet365, draftkings, fanduel, caesars, betmgm].filter(Boolean);
            
            allPlayersData = {};
            
            const allPlayerNames = new Set();
            bookmakers.forEach(bookie => {
                bookie.markets.forEach(market => {
                    market.outcomes.forEach(outcome => allPlayerNames.add(outcome.description));
                });
            });


            allPlayerNames.forEach(playerName => {
                const addedMarkets = new Set();
                
                const findAndAddMarket = (marketKey, priorityList) => {
                    if (addedMarkets.has(marketKey)) return;

                    for (const bookmaker of priorityList) {
                        const market = bookmaker.markets.find(m => m.key === marketKey);
                        if (market) {
                            const outcomes = market.outcomes.filter(o => o.description === playerName);
                            if (outcomes.length > 0) {
                                if (!allPlayersData[playerName]) allPlayersData[playerName] = [];
                                
                                outcomes.forEach(outcome => {
                                    allPlayersData[playerName].push({
                                        marketKey: market.key,
                                        marketName: marketsMap[market.key] || market.key,
                                        outcome: outcome,
                                        bookmaker: bookmaker.title
                                    });
                                });
                                addedMarkets.add(marketKey);
                                return;
                            }
                        }
                    }
                };
                
                Object.keys(marketsMap).forEach(marketKey => {
                    findAndAddMarket(marketKey, defaultPriority);
                });
            });
        }
        
        function setupCsvBuilder(homeTeam, awayTeam) {
             builderTabContent.innerHTML = '';
             if (Object.keys(allPlayersData).length === 0 && soccerPlayersData.length === 0) { 
                builderTabContent.innerHTML = '<p class="text-center text-gray-500">No player prop markets found for this game.</p>';
                return;
            }

            const getDropdownOptions = (selectedTeam = null) => {
                const teamsToInclude = selectedTeam ? [selectedTeam] : [homeTeam, awayTeam];
                
                // Koristimo soccerPlayersData za filtriranje
                const teamPlayerNames = soccerPlayersData 
                    .filter(p => teamsToInclude.includes(p.team))
                    .map(p => p.name);

                // Filtriramo samo one igrače za koje imamo kvote
                return teamPlayerNames
                    .filter(name => allPlayersData[name]) 
                    .sort();
            };

            const initialOptions = getDropdownOptions();

            const builderHTML = `
                <div class="space-y-6">
                    <div>
                        <label for="leagueTeamDropdown" class="block text-sm font-medium text-gray-700 mb-2">Team for LEAGUE_NAME</label>
                        <select id="leagueTeamDropdown" class="w-full p-3 bg-white bg-opacity-80 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">-- Select Team --</option>
                            <option value="${awayTeam}">${awayTeam}</option>
                            <option value="${homeTeam}">${homeTeam}</option>
                        </select>
                    </div>
                    <div>
                         <label for="playerAddDropdown" class="block text-sm font-medium text-gray-700 mb-2">Add Player to List</label>
                         <div class="flex">
                            <select id="playerAddDropdown" class="w-full p-3 bg-white bg-opacity-80 border border-gray-200 rounded-l-xl focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">-- Select a player --</option>
                                ${initialOptions.map(name => `<option value="${name}">${name}</option>`).join('')}
                            </select>
                            <button id="addPlayerButton" class="px-5 py-3 bg-blue-600 text-white font-semibold rounded-r-xl hover:bg-blue-700 transition-colors">Add</button>
                        </div>
                    </div>
                </div>
                <div id="export-list-container" class="mt-6 space-y-4"></div>
                <div id="export-actions-container" class="hidden mt-8 grid grid-cols-2 sm:grid-cols-4 gap-4">
                    <button id="previewCsvButton" class="w-full py-3 px-4 bg-indigo-600 text-white font-medium rounded-xl hover:bg-indigo-700 transition-colors">Preview CSV</button>
                    <button id="exportCsvButton" class="w-full py-3 px-4 bg-green-600 text-white font-medium rounded-xl hover:bg-green-700 transition-colors">Export to CSV</button>
                    <button id="resetCsvButton" class="w-full py-3 px-4 bg-red-600 text-white font-medium rounded-xl hover:bg-red-700 transition-colors">Reset</button>
                    <button id="newCsvButton" class="w-full py-3 px-4 bg-yellow-500 text-white font-medium rounded-xl hover:bg-yellow-600 transition-colors">New CSV</button>
                </div>
            `;
            builderTabContent.innerHTML = builderHTML;

            const leagueTeamDropdown = document.getElementById('leagueTeamDropdown');
            const playerAddDropdown = document.getElementById('playerAddDropdown');

            leagueTeamDropdown.addEventListener('change', (e) => {
                const selectedTeam = e.target.value;
                const newOptions = getDropdownOptions(selectedTeam);
                playerAddDropdown.innerHTML = `<option value="">-- Select a player --</option>` + 
                                              newOptions.map(name => `<option value="${name}">${name}</option>`).join('');
            });
            
            document.getElementById('addPlayerButton').addEventListener('click', handleAddPlayer);
            document.getElementById('previewCsvButton').addEventListener('click', previewCsv);
            document.getElementById('exportCsvButton').addEventListener('click', exportToCsv);
            document.getElementById('export-list-container').addEventListener('click', handleRemoveMarket);
            document.getElementById('export-list-container').addEventListener('input', handleDataChange);
            document.getElementById('resetCsvButton').addEventListener('click', resetCsvForm);
            document.getElementById('newCsvButton').addEventListener('click', resetCsvForm);
        }

        function resetCsvForm() {
            selectedDataForExport = {};
            const leagueTeamDropdown = document.getElementById('leagueTeamDropdown');
            if(leagueTeamDropdown) leagueTeamDropdown.value = '';
            const playerAddDropdown = document.getElementById('playerAddDropdown');
            if(playerAddDropdown) playerAddDropdown.value = '';
            // Ponovo iscrtaj praznu listu
            renderSelectedPlayersAndMarkets();
            // Sakrij dugmiće za akcije
            const actionsContainer = document.getElementById('export-actions-container');
            if(actionsContainer) actionsContainer.classList.add('hidden');
        }
        
        function handleAddPlayer() {
            const playerDropdown = document.getElementById('playerAddDropdown');
            const playerName = playerDropdown.value;
            if (playerName && !selectedDataForExport[playerName]) {
                if (allPlayersData[playerName]) {
                    // Duboko kopiranje da se izbegne referenciranje
                    selectedDataForExport[playerName] = JSON.parse(JSON.stringify(allPlayersData[playerName]));
                } 
                renderSelectedPlayersAndMarkets();
            }
            playerDropdown.value = '';
        }

        
        function handleRemoveMarket(event) {
            const removeButton = event.target.closest('.remove-market-btn');
            if (!removeButton) return;
            const { player, marketKey } = removeButton.dataset;
            if (selectedDataForExport[player]) {
                selectedDataForExport[player] = selectedDataForExport[player].filter(market => market.marketKey !== marketKey);
                if (selectedDataForExport[player].length === 0) {
                    delete selectedDataForExport[player];
                }
                renderSelectedPlayersAndMarkets();
            }
        }

        function handleDataChange(event) {
            const input = event.target;
            if (!input.classList.contains('editable-input')) return;
            const { player, marketKey, type } = input.dataset;
            const newValue = input.value;
            
            if (!selectedDataForExport[player]) return;

            selectedDataForExport[player].forEach(market => {
                if (market.marketKey === marketKey) {
                    const outcomeName = market.outcome.name;
                    if (type === 'line') {
                        market.outcome.point = parseFloat(newValue) || 0;
                    } else if (type.toLowerCase() === outcomeName.toLowerCase()) {
                         market.outcome.price = parseFloat(newValue) || 0;
                    }
                }
            });
        }

        function renderSelectedPlayersAndMarkets() {
            const listContainer = document.getElementById('export-list-container');
            const actionsContainer = document.getElementById('export-actions-container');
            listContainer.innerHTML = '';
            
            if (Object.keys(selectedDataForExport).length === 0) {
                actionsContainer.classList.add('hidden');
                return;
            }

            for (const playerName in selectedDataForExport) {
                const marketsForPlayer = selectedDataForExport[playerName];
                // Grupišemo po marketKey
                const groupedMarkets = marketsForPlayer.reduce((acc, marketData) => {
                    const key = marketData.marketKey;
                    if (!acc[key]) {
                        acc[key] = { 
                            marketName: marketData.marketName, 
                            outcomes: {} 
                        };
                    }
                    // Čuvamo ceo 'outcome' objekat
                    acc[key].outcomes[marketData.outcome.name] = marketData.outcome;
                    return acc;
                }, {});

                let tableHTML = `
                    <div class="glassmorphic rounded-xl p-4">
                        <h4 class="text-lg font-semibold text-gray-800 mb-3">${playerName}</h4>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white bg-opacity-70 text-sm">
                                <thead class="bg-gray-50 bg-opacity-70">
                                    <tr>
                                        <th class="px-4 py-2 text-left font-medium">Market</th>
                                        <th class="px-4 py-2 text-left font-medium">Line</th>
                                        <th class="px-4 py-2 text-left font-medium">Over / Yes</th>
                                        <th class="px-4 py-2 text-left font-medium">Under / No</th>
                                        <th class="px-4 py-2 text-right font-medium"></th>
                                    </tr>
                                </thead>
                                <tbody>`;

                for (const marketKey in groupedMarkets) {
                    const market = groupedMarkets[marketKey];
                    const overOutcome = market.outcomes['Over'];
                    const underOutcome = market.outcomes['Under'];
                    const yesOutcome = market.outcomes['Yes'];
                    const noOutcome = market.outcomes['No'];
                    
                    const editableInputBaseClasses = "editable-input w-full p-2 bg-gray-100 bg-opacity-70 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500";

                    // Linija postoji samo za Over/Under markete
                    const line = overOutcome?.point ?? underOutcome?.point ?? '';
                    // Kvota za Yes ili Over
                    const priceYesOver = yesOutcome?.price ?? overOutcome?.price ?? '';
                    // Kvota za No ili Under
                    const priceNoUnder = noOutcome?.price ?? underOutcome?.price ?? '';
                    
                    tableHTML += `
                        <tr class="border-t border-gray-200">
                            <td class="px-4 py-2">${market.marketName}</td>
                            <td class="px-4 py-2">
                                <input type="text" class="${editableInputBaseClasses}" value="${line}" 
                                       data-player="${playerName}" data-market-key="${marketKey}" data-type="line" 
                                       ${!line ? 'disabled' : ''}>
                            </td>
                            <td class="px-4 py-2">
                                <input type="text" class="${editableInputBaseClasses}" value="${priceYesOver}" 
                                       data-player="${playerName}" data-market-key="${marketKey}" data-type="${yesOutcome ? 'yes' : 'over'}"
                                       ${!priceYesOver ? 'disabled' : ''}>
                            </td>
                            <td class="px-4 py-2">
                                <input type="text" class="${editableInputBaseClasses}" value="${priceNoUnder}" 
                                       data-player="${playerName}" data-market-key="${marketKey}" data-type="${noOutcome ? 'no' : 'under'}"
                                       ${!priceNoUnder ? 'disabled' : ''}>
                            </td>
                            <td class="px-4 py-2 text-right">
                                <button class="text-red-500 hover:text-red-700 remove-market-btn" 
                                        data-player="${playerName}" data-market-key="${marketKey}">Remove</button>
                            </td>
                        </tr>`;
                }
                tableHTML += `</tbody></table></div></div>`;
                listContainer.innerHTML += tableHTML;
            }
            actionsContainer.classList.remove('hidden');
        }


        function generateCsvData() {
            const leagueTeam = document.getElementById('leagueTeamDropdown').value;
            if (!leagueTeam) {
                alert('Please select a team for the LEAGUE_NAME.');
                return null;
            }
            if (Object.keys(selectedDataForExport).length === 0) {
                alert('The export list is empty. Please add some players and markets.');
                return null;
            }
            const kickoffDate = new Date(currentEventCommenceTime);
            const day = String(kickoffDate.getDate()).padStart(2, '0');
            const month = String(kickoffDate.getMonth() + 1).padStart(2, '0');
            const year = kickoffDate.getFullYear();
            const dateStr = `${day}.${month}.${year}`;
            const timeStr = kickoffDate.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
            
            let csvRows = [];
            // Ažurirani headeri za fudbal
            const headers = ['Datum', 'Vreme', 'Igrac', 'Tim', 'Market', 'Linija', 'Kvota (Yes/Over)', 'Kvota (No/Under)'];
            csvRows.push(headers);
            csvRows.push(['MATCH_NAME:Football Player Props']); 
            csvRows.push([`LEAGUE_NAME:${leagueTeam} Specijal`]); 
            
            for (const playerName in selectedDataForExport) {
                const playerTeam = findPlayerTeam(playerName); // Nalazimo tim igrača
                const marketsForPlayer = selectedDataForExport[playerName];
                
                // Grupišemo po marketKey
                const groupedMarkets = marketsForPlayer.reduce((acc, marketData) => {
                    const key = marketData.marketKey;
                    if (!acc[key]) acc[key] = { marketName: marketData.marketName, outcomes: {} };
                    acc[key].outcomes[marketData.outcome.name] = marketData.outcome;
                    return acc;
                }, {});

                for (const marketKey in groupedMarkets) {
                    const market = groupedMarkets[marketKey];
                    // 8 kolona, popunjene praznim stringom
                    const row = Array(8).fill(''); 
                    
                    row[0] = dateStr;
                    row[1] = timeStr;
                    row[2] = playerName;
                    row[3] = playerTeam; // Dodajemo tim
                    row[4] = market.marketName;

                    const over = market.outcomes['Over'];
                    const under = market.outcomes['Under'];
                    const yes = market.outcomes['Yes'];
                    const no = market.outcomes['No'];
                    
                    if (over || under) {
                        row[5] = over?.point ?? under?.point ?? ''; // Linija
                        row[6] = over?.price ?? ''; // Over kvota
                        row[7] = under?.price ?? ''; // Under kvota
                    } else if (yes || no) {
                        row[5] = ''; // Nema linije za Yes/No
                        row[6] = yes?.price ?? ''; // Yes kvota
                        row[7] = no?.price ?? ''; // No kvota
                    }
                    csvRows.push(row);
                }
            };
            return csvRows;
        }

        function previewCsv() {
            const csvRows = generateCsvData();
            if (!csvRows) return;
            const csvContentString = csvRows.map(e => e.join(",")).join("\n");
            document.getElementById('csvPreviewContent').textContent = csvContentString;
            modal.classList.remove('hidden');
        }

        function exportToCsv() {
            const csvRows = generateCsvData();
            if (!csvRows) return;
            let csvContent = "data:text/csv;charset=utf-8," + csvRows.map(e => e.join(",")).join("\r\n");
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            const leagueTeam = document.getElementById('leagueTeamDropdown').value;
            const sportName = leagueDropdown.options[leagueDropdown.selectedIndex].text.split(' ')[0]; // npr. "English"
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `${leagueTeam}_${sportName}_player_props.csv`); 
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        allOddsTabContent.addEventListener('click', (event) => {
            const addButton = event.target.closest('.add-player-from-all-odds-btn');
            if (addButton) {
                const playerName = addButton.dataset.playerName;
                if (!playerName || !allPlayersData[playerName]) return;

                if (selectedDataForExport[playerName]) {
                    alert('Player is already added to the CSV Builder.');
                    return;
                }

                selectedDataForExport[playerName] = JSON.parse(JSON.stringify(allPlayersData[playerName]));
                renderSelectedPlayersAndMarkets();
                
                addButton.textContent = 'Added';
                addButton.disabled = true;
                addButton.classList.add('bg-green-600', 'cursor-not-allowed');
            }
        });

        function renderAllOddsView() {
            allOddsTabContent.innerHTML = '';
            const bookmakers = currentFullGameData?.bookmakers;

            if (!bookmakers || bookmakers.length === 0) {
                allOddsTabContent.innerHTML = '<p class="text-center text-gray-500">No odds available for this game.</p>';
                return;
            }

            // Mapiramo sve igrače po svim marketima
            const allAvailableMarkets = {};
            bookmakers.forEach(bookie => {
                bookie.markets.forEach(market => {
                    if (!allAvailableMarkets[market.key]) {
                        allAvailableMarkets[market.key] = { players: {} };
                    }
                    market.outcomes.forEach(outcome => {
                        if (!allAvailableMarkets[market.key].players[outcome.description]) {
                            allAvailableMarkets[market.key].players[outcome.description] = {};
                        }
                    });
                });
            });

            let contentHTML = '';
            for (const marketKey in allAvailableMarkets) {
                // Proveravamo tip marketa (Over/Under ili Yes/No)
                let marketType = 'yes-no'; // default
                const firstBookmakerWithMarket = bookmakers.find(b => b.markets.some(m => m.key === marketKey));
                if (firstBookmakerWithMarket) {
                    const marketSample = firstBookmakerWithMarket.markets.find(m => m.key === marketKey);
                    if (marketSample && marketSample.outcomes.some(o => o.name === 'Over' || o.name === 'Under')) {
                        marketType = 'over-under';
                    }
                }
                
                contentHTML += `<div class="glassmorphic rounded-xl p-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-3">${marketsMap[marketKey] || marketKey}</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white bg-opacity-70 text-sm">
                            <thead class="bg-gray-50 bg-opacity-70">
                                <tr>
                                    <th class="px-4 py-2 text-left font-medium">Player</th>`;
                bookmakers.forEach(bookie => {
                    contentHTML += `<th class="px-4 py-2 text-center font-medium">${bookie.title}</th>`;
                });
                contentHTML += `<th class="px-4 py-2 text-right font-medium">Action</th></tr></thead><tbody>`;

                const players = Object.keys(allAvailableMarkets[marketKey].players).sort();
                players.forEach(playerName => {
                    const team = findPlayerTeam(playerName); 
                    const isAlreadyAdded = !!selectedDataForExport[playerName];
                    
                    let teamHTML = `<span class="text-xs text-gray-500 font-normal">(${team})</span>`;

                    contentHTML += `<tr class="border-t border-gray-200">
                        <td class="px-4 py-2 font-medium">
                            ${playerName} ${teamHTML}
                        </td>`;
                    bookmakers.forEach(bookie => {
                        let cellContent = '-';
                        const market = bookie.markets.find(m => m.key === marketKey);
                        if (market) {
                            const outcomes = market.outcomes.filter(o => o.description === playerName);
                            if (outcomes.length > 0) {
                                if (marketType === 'over-under') {
                                    const over = outcomes.find(o => o.name === 'Over');
                                    const under = outcomes.find(o => o.name === 'Under');
                                    cellContent = `
                                        <div class="text-center text-xs">
                                            ${over ? `<div>O ${over.point} (${over.price})</div>` : ''}
                                            ${under ? `<div>U ${under.point} (${under.price})</div>` : ''}
                                        </div>
                                    `;
                                } else { // Yes/No market
                                    const yes = outcomes.find(o => o.name === 'Yes');
                                    const no = outcomes.find(o => o.name === 'No');
                                     cellContent = `
                                        <div class="text-center text-xs">
                                            ${yes ? `<div>Yes (${yes.price})</div>` : ''}
                                            ${no ? `<div>No (${no.price})</div>` : ''}
                                        </div>
                                    `;
                                }
                            }
                        }
                        contentHTML += `<td class="px-4 py-2">${cellContent}</td>`;
                    });
                    
                    contentHTML += `
                        <td class="px-4 py-2 text-right">
                            <button 
                                class="add-player-from-all-odds-btn text-white font-bold py-1 px-3 rounded-lg text-xs transition-colors ${isAlreadyAdded ? 'bg-green-600 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700'}" 
                                data-player-name="${playerName}"
                                ${isAlreadyAdded ? 'disabled' : ''}>
                                ${isAlreadyAdded ? 'Added' : 'Add'}
                            </button>
                        </td>
                    </tr>`;
                });
                contentHTML += `</tbody></table></div></div>`;
            }
            allOddsTabContent.innerHTML = contentHTML;
        }

    </script>
</body>
</html>
